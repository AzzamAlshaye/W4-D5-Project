<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Details â€“ Time Machine</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
  </head>
  <body class="container py-5">
    <div class="event-details">
      <h2 id="event-title"></h2>
      <p><em id="event-date"></em></p>
      <p id="event-desc"></p>

      <hr />
      <h4>Comments</h4>
      <div id="comments-list" class="mb-4"></div>

      <form id="commentForm">
        <div class="mb-3">
          <textarea
            name="comment"
            class="form-control"
            rows="2"
            placeholder="Leave a comment..."
            required
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Post Comment</button>
      </form>
    </div>

    <script>
      // STORAGE HELPERS
      function getData(key) {
        return JSON.parse(localStorage.getItem(key)) || [];
      }
      function setData(key, val) {
        localStorage.setItem(key, JSON.stringify(val));
      }

      // AUTH CHECK
      function currentUser() {
        return localStorage.getItem("currentUser");
      }

      // EVENTS & COMMENTS
      function getEvents() {
        return getData("events");
      }
      function getComments(eventId) {
        return getData("comments").filter((c) => c.eventId === eventId);
      }
      function addComment(eventId, text) {
        const comments = getData("comments");
        comments.push({
          eventId,
          user: currentUser(),
          text,
          timestamp: Date.now(),
        });
        setData("comments", comments);
      }

      // PAGE LOGIC
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get("id"), 10);
        const events = getEvents();

        // validate ID
        if (isNaN(id) || id < 0 || id >= events.length) {
          document.body.innerHTML =
            '<p class="text-center text-danger mt-5">Event not found.</p>';
          return;
        }

        // populate event
        const e = events[id];
        document.getElementById("event-title").textContent = e.title;
        document.getElementById("event-date").textContent = e.date;
        document.getElementById("event-desc").textContent = e.description;

        // render comments
        const comList = document.getElementById("comments-list");
        getComments(id).forEach((c) => {
          const card = document.createElement("div");
          card.className = "border p-3 mb-2";
          card.innerHTML = `
          <strong>${c.user}</strong>
          <small class="text-muted float-end">${new Date(
            c.timestamp
          ).toLocaleString()}</small>
          <p class="mt-2 mb-0">${c.text}</p>
        `;
          comList.append(card);
        });

        // comment form
        const form = document.getElementById("commentForm");
        if (!currentUser()) {
          form.innerHTML =
            '<p>Please <a href="login.html">log in</a> to comment.</p>';
        } else {
          form.addEventListener("submit", (ev) => {
            ev.preventDefault();
            const txt = ev.target.comment.value.trim();
            if (txt) {
              addComment(id, txt);
              // reload to show the new comment
              window.location.reload();
            }
          });
        }
      });
    </script>
  </body>
</html>
