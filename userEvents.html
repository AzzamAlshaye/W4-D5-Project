<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Details – Time Machine</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link href="./assests/css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-main">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <img
            src="./assests/images/logos/logo-gold.png"
            height="80"
            alt="logo"
          />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#">TV Shows</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Movies</a></li>
          </ul>
          <ul class="navbar-nav mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="profile.html"
                ><i class="fa fa-user-circle fa-2x"></i
              ></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container my-5 pt-5">
      <!-- Event Image -->
      <div class="card mt-5">
        <div class="card-body">
          <h1 id="event-title" class="card-title"></h1>
          <div class="row">
            <div class="col-12 col-md-4 mx-auto text-center mb-4">
              <img id="event-img" class="img-fluid rounded" alt="…" />
            </div>
          </div>
          <p id="event-date" class="text-muted"></p>
          <p id="event-desc" class="card-text"></p>
        </div>
      </div>

      <!-- Comments Section -->
      <section>
        <h3>Comments</h3>
        <div id="comments-list" class="mb-4"></div>

        <form id="commentForm">
          <div class="mb-3">
            <label for="comment" class="form-label">Add a comment</label>
            <textarea
              id="comment"
              name="comment"
              class="form-control"
              rows="3"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn-main">Submit</button>
        </form>
      </section>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
      integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
      crossorigin="anonymous"
    ></script>
    <script src="./assests/js/app.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        let id = parseInt(params.get("id"), 10);
        // if you’re using raw year as key, uncomment:
        // id = id - 1930;

        const events = getEvents();
        const e = events[id];
        if (!e) {
          document.body.innerHTML =
            '<p class="text-center mt-5">Event not found.</p>';
          return;
        }

        // Populate image & text
        document.getElementById("event-img").src = e.img;
        document.getElementById("event-img").alt = e.title;
        document.getElementById("event-title").textContent = e.title;
        document.getElementById("event-date").textContent = e.date;
        document.getElementById("event-desc").textContent = e.description;

        // Render comments with delete
        const comContainer = document.getElementById("comments-list");
        const comments = getComments(id);
        const me = currentUser();

        comments.forEach((c, idx) => {
          const div = document.createElement("div");
          div.className = "mb-3 p-3 border rounded position-relative";
          div.innerHTML = `
            <strong>${c.user}</strong>
            <small class="text-muted float-end">${new Date(
              c.timestamp
            ).toLocaleString()}</small>
            <p class="mt-2 mb-0">${c.text}</p>
          `;

          if (me && c.user === me) {
            const btn = document.createElement("button");
            btn.className = "btn btn-sm btn-outline-danger position-absolute";
            btn.style.top = "3rem";
            btn.style.right = "0.5rem";
            btn.textContent = "Delete";
            btn.addEventListener("click", () => {
              if (!confirm("Delete your comment?")) return;
              deleteComment(id, idx);
              div.remove();
            });
            div.append(btn);
          }

          comContainer.append(div);
        });

        // Comment form
        const form = document.getElementById("commentForm");
        if (!currentUser()) {
          form.innerHTML =
            '<p>Please <a href="login.html">log in</a> to comment.</p>';
        } else {
          form.addEventListener("submit", (ev) => {
            ev.preventDefault();
            addComment(id, ev.target.comment.value.trim());
            window.location.reload();
          });
        }
      });
    </script>
  </body>
</html>
